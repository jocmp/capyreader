<!doctype html>
<html dir="auto">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <style>
      :root {
        --color-primary: {{color_primary}};
        --color-surface: {{color_surface}};
        --color-surface-container-highest: {{color_surface_container_highest}};
        --color-on-surface: {{color_on_surface}};
        --color-on-surface-variant: {{color_on_surface_variant}};
        --color-surface-variant: {{color_surface_variant}};
        --color-primary-container: {{color_primary_container}};
        --color-on-primary-container: {{color_on_primary_container}};
        --color-secondary: {{color_secondary}};
        --color-surface-container: {{color_surface_container}};
        --color-surface-tint: {{color_surface_tint}};
        --article-top-margin: {{top_margin}};
        --article-font-size: {{font_size}};
        --pre-white-space: {{pre_white_space}};
      }
    </style>
    {{font_preload}}
    <link rel="stylesheet" href="https://appassets.androidplatform.net/assets/stylesheet.css">
    <script>
      function configureVideoTags() {
        [...document.getElementsByTagName('video')].forEach((v) => {
          v.setAttribute('preload', 'auto');
          v.setAttribute('playsinline', 'true');
          v.setAttribute('controls', 'true');
          v.setAttribute('controlslist', 'nofullscreen nodownload noremoteplayback');

          if (v.classList.contains('article__video-autoplay--looped')) {
            v.setAttribute('loop', 'true');
            v.play();
          }
        });
      }

      function addImageClickListeners() {
        [...document.getElementsByTagName('img')].forEach((img) => {
          if (img.classList.contains('iframe-embed__image')) {
            return;
          }

          img.addEventListener('click', () => {
            Android.openImage(img.src, img.alt);
          });
        });
      }

      function addEmbedListeners() {
        [...document.querySelectorAll('div.iframe-embed')].forEach((div) => {
          div.addEventListener('click', () => {
            const iframe = document.createElement('iframe');
            iframe.src = div.getAttribute('data-iframe-src') || '';
            div.replaceWith(iframe);
          });
        });

        [...document.querySelectorAll('a')].forEach((anchor) => {
          longPress(anchor, () => {
            Android.showLinkDialog(anchor.href, anchor.text);
          });
        });
      }

      /**
       * @param {HTMLDivElement | Document} element
       * @returns boolean
       */
      function cleanEmbeds(element = document) {
        const imgs = element.querySelectorAll('img');

        for (const img of imgs) {
          if (!img.src) {
            img.remove();
          }
        }

        const embeds = element.querySelectorAll('iframe');

        for (const embed of embeds) {
          const src = embed.getAttribute('src');
          if (!src) {
            continue;
          }

          const youtubeID = findYouTubeMatch(src);

          if (youtubeID !== null) {
            swapPlaceholder(embed, src, youtubeID);
          }
        }

        addEmbedListeners();
      }

      /**
       * @param {string} src
       */
      function findYouTubeMatch(src) {
        for (const regex of YOUTUBE_DOMAINS) {
          const match = src.match(regex);
          if (match) {
            return match[1];
          }
        }
        return null;
      }

      /**
       * @param {HTMLIFrameElement} embed
       * @param {string} src
       * @param {string} youtubeID
       */
      function swapPlaceholder(embed, src, youtubeID) {
        const placeholderImage = document.createElement('img');
        placeholderImage.classList.add('iframe-embed__image', 'mercury-parser-keep');
        placeholderImage.setAttribute('src', imageURL(youtubeID));

        const playButton = document.createElement('div');
        playButton.classList.add('iframe-embed__play-button');

        const placeholder = document.createElement('div');
        placeholder.classList.add('iframe-embed');
        placeholder.setAttribute('data-iframe-src', autoplaySrc(src));
        placeholder.appendChild(placeholderImage);
        placeholder.appendChild(playButton);

        embed.replaceWith(placeholder);
      }

      function imageURL(id) {
        return `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
      }

      /**
       * @param {string} src
       * @returns string
       */
      function autoplaySrc(src) {
        try {
          const url = new URL(src);
          url.searchParams.set('autoplay', '1');
          return url.toString();
        } catch (e) {
          return src;
        }
      }

      const YOUTUBE_DOMAINS = [
        /.*?\/\/www\.youtube-nocookie\.com\/embed\/(.*?)(\?|$)/,
        /.*?\/\/www\.youtube\.com\/embed\/(.*?)(\?|$)/,
        /.*?\/\/www\.youtube\.com\/user\/.*?#\w\/\w\/\w\/\w\/(.+)\b/,
        /.*?\/\/www\.youtube\.com\/v\/(.*?)(#|\?|$)/,
        /.*?\/\/www\.youtube\.com\/watch\?(?:.*?&)?v=([^&#]*)(?:&|#|$)/,
        /.*?\/\/youtube-nocookie\.com\/embed\/(.*?)(\?|$)/,
        /.*?\/\/youtube\.com\/embed\/(.*?)(\?|$)/,
        /.*?\/\/youtu\.be\/(.*?)(\?|$)/,
      ];

      /**
       * @param {HTMLElement} element
       * @param {(event: Event) => void} callback
       */
      function longPress(element, callback) {
        let timer;

        const start = (/** @type {Event} */ event) => {
          timer = setTimeout(() => {
            callback(event);
          }, 500);
        };

        const stop = () => {
          clearTimeout(timer);
        };

        element.addEventListener('mousedown', start);
        element.addEventListener('mouseup', stop);
        element.addEventListener('mouseleave', stop);

        element.addEventListener('touchstart', start);
        element.addEventListener('touchend', stop);
        element.addEventListener('touchcancel', stop);
      }

      window.addEventListener('DOMContentLoaded', () => {
        cleanEmbeds();
        addImageClickListeners();
        addEmbedListeners();
        configureVideoTags();
      });

      /**
       * @param {Object} article
       * @param {string} article.html
       * @param {string | null} article.url
       * @param {boolean} article.hideImages
       */
      async function displayFullContent(article) {
        const { url, html, hideImages } = article;

        try {
          const result = await Mercury.parse(url, { html });
          const extracted = document.createElement('div');

          extracted.id = 'article-body-content';
          extracted.innerHTML = result.content;

          cleanEmbeds(extracted);

          const shouldAddImage =
            result.lead_image_url &&
            !hideImages &&
            !extracted.querySelectorAll('img:not(iframe img):not(.iframe-embed img)').length;

          if (shouldAddImage) {
            const leadImage = document.createElement('img');
            leadImage.src = result.lead_image_url;
            extracted.prepend(leadImage);
          }

          const content = document.getElementById('article-body-content');
          content.replaceWith(extracted);
        } catch {
          // continue
        }
      }
    </script>
    <script type="text/javascript" src="https://appassets.androidplatform.net/assets/mercury-parser.js"></script>
  </head>
  <body>
    <article role="main">
      <header>
        <a class="article__header" href="{{external_link}}">
          <h1 class="article__title">{{title}}</h1>
          <div>{{byline}}</div>
          <div>{{feed_name}}</div>
        </a>
      </header>
      <div class="article__body article__body--font-{{font_family}}">
        <div id="article-body-content"></div>
      </div>
    </article>
  </body>
</html>
